name: Build and Release

on:
    push:
        tags:
            - 'v*'

jobs:
    build:
        runs-on: ${{ matrix.os }}

        strategy:
            matrix:
                os: [macos-latest, windows-latest]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build and publish
              run: npx electron-builder --publish always
              env:
                  DEBUG: electron-builder*
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Update release with download links
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  body: |
                    ## Downloads

                    ### Windows
                    - **[ARK Locator Setup ${{ github.ref_name }}.exe](https://github.com/jonschr/ark-locator/releases/download/${{ github.ref_name }}/ARK%20Locator%20Setup%20${{ github.ref_name }}.exe)** - Windows installer

                    ### macOS
                    - **[ARK Locator ${{ github.ref_name }}-arm64.dmg](https://github.com/jonschr/ark-locator/releases/download/${{ github.ref_name }}/ARK%20Locator-${{ github.ref_name }}-arm64.dmg)** - macOS installer

                    ## Installation

                    1. Download the installer for your platform above
                    2. Run the installer and follow the setup wizard
                    3. Launch ARK Locator from your applications menu

                    ## What's New

                    See the changelog for details about this release.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
